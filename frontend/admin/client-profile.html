<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Client Profile - FitMates Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/navbar.css" />
    <link rel="stylesheet" href="/assets/css/admin.css" />
    <style>
      .profile-header {
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        display: flex;
        gap: var(--spacing-xl);
        align-items: center;
      }

      .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: var(--gradient-accent);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        flex-shrink: 0;
      }

      .profile-info {
        flex: 1;
      }

      .profile-name {
        font-size: 1.75rem;
        margin-bottom: var(--spacing-xs);
      }

      .profile-meta {
        display: flex;
        gap: var(--spacing-lg);
        flex-wrap: wrap;
        margin-top: var(--spacing-md);
      }

      .profile-meta-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: 0.875rem;
        color: var(--color-text-secondary);
      }

      .tabs {
        display: flex;
        gap: var(--spacing-md);
        border-bottom: 2px solid var(--color-border);
        margin-bottom: var(--spacing-xl);
      }

      .tab {
        padding: var(--spacing-md) var(--spacing-lg);
        background: none;
        border: none;
        color: var(--color-text-secondary);
        font-weight: 600;
        cursor: pointer;
        position: relative;
        transition: color var(--transition-fast);
      }

      .tab:hover {
        color: var(--color-text-primary);
      }

      .tab.active {
        color: var(--color-accent-red);
      }

      .tab.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--gradient-accent);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-out;
      }

      .forms-list {
        display: grid;
        gap: var(--spacing-md);
      }

      .form-item {
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all var(--transition-fast);
      }

      .form-item:hover {
        border-color: var(--color-accent-red);
        transform: translateX(4px);
      }

      .form-item-info h4 {
        margin-bottom: var(--spacing-xs);
      }

      .form-item-meta {
        font-size: 0.75rem;
        color: var(--color-text-tertiary);
      }

      .form-item-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      /* Form Builder Styles */
      .form-builder {
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
      }

      .form-builder-header {
        margin-bottom: var(--spacing-xl);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
      }

      .fields-list {
        display: grid;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
      }

      .field-item {
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
      }

      .field-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
      }

      .field-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-md);
      }

      .add-field-btn {
        border: 2px dashed var(--color-border);
        background: transparent;
        padding: var(--spacing-lg);
        border-radius: var(--radius-md);
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: all var(--transition-fast);
        font-weight: 600;
      }

      .add-field-btn:hover {
        border-color: var(--color-accent-red);
        color: var(--color-accent-red);
        background: rgba(239, 68, 68, 0.05);
      }

      /* Reports Styles */
      .reports-list {
        display: grid;
        gap: var(--spacing-lg);
      }

      .report-card {
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
      }

      .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
      }

      .metric-card {
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
      }

      .metric-label {
        font-size: 0.75rem;
        color: var(--color-text-tertiary);
        text-transform: uppercase;
        margin-bottom: var(--spacing-xs);
      }

      .metric-values {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: var(--spacing-sm);
      }

      .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .metric-target {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
      }

      .metric-progress {
        height: 6px;
        background: var(--color-bg-tertiary);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: var(--spacing-xs);
      }

      .metric-progress-bar {
        height: 100%;
        background: var(--gradient-accent);
        transition: width var(--transition-normal);
      }

      .metric-status {
        font-size: 0.75rem;
        font-weight: 600;
      }

      /* Tab Header Styles */
      .tab-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-xl);
      }

      /* Submission Card Styles (matching user submissions page) */
      .submission-card {
        background: linear-gradient(
          135deg,
          rgba(26, 26, 26, 0.95) 0%,
          rgba(10, 10, 10, 0.98) 100%
        );
        border: 1px solid rgba(239, 68, 68, 0.15);
        border-radius: var(--radius-xl);
        padding: var(--spacing-2xl);
        margin-bottom: var(--spacing-xl);
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
      }

      .submission-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: var(--gradient-shimmer);
        transition: left 0.6s;
        pointer-events: none;
      }

      .submission-card:hover {
        border-color: var(--color-accent-red);
        transform: translateY(-4px);
        box-shadow: 0 15px 30px rgba(239, 68, 68, 0.2);
      }

      .submission-card:hover::before {
        left: 100%;
      }

      .submission-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid rgba(239, 68, 68, 0.1);
      }

      .submission-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-text-primary);
      }

      .submission-date {
        font-size: 0.875rem;
        color: var(--color-text-tertiary);
      }

      .submission-data {
        display: grid;
        gap: var(--spacing-md);
      }

      .data-row {
        display: flex;
        gap: var(--spacing-lg);
        padding: var(--spacing-md);
        background: rgba(239, 68, 68, 0.05);
        border-radius: var(--radius-md);
        border-left: 3px solid var(--color-accent-red);
      }

      .data-label {
        min-width: 200px;
        font-weight: 600;
        color: var(--color-text-secondary);
      }

      .data-value {
        flex: 1;
        color: var(--color-text-primary);
        font-weight: 500;
      }

      /* Mobile Responsive Styles */
      @media (max-width: 768px) {
        /* Tab header responsive */
        .tab-header {
          flex-direction: column;
          align-items: flex-start;
          gap: var(--spacing-md);
        }

        .tab-header h2 {
          font-size: 1.5rem;
        }

        .tab-header .btn {
          width: 100%;
          justify-content: center;
        }

        .profile-header {
          flex-direction: column;
          text-align: center;
          padding: var(--spacing-lg);
        }

        .profile-avatar {
          width: 80px;
          height: 80px;
          font-size: 2rem;
        }

        .profile-name {
          font-size: 1.5rem;
        }

        .profile-meta {
          justify-content: center;
          gap: var(--spacing-md);
        }

        .profile-meta-item {
          font-size: 0.8rem;
        }

        .tabs {
          gap: var(--spacing-xs);
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none; /* Firefox */
          -ms-overflow-style: none; /* IE and Edge */
        }

        .tabs::-webkit-scrollbar {
          display: none; /* Chrome, Safari, Opera */
        }

        .tab {
          padding: var(--spacing-sm) var(--spacing-md);
          font-size: 0.875rem;
          white-space: nowrap;
        }

        .form-item {
          flex-direction: column;
          align-items: flex-start;
          gap: var(--spacing-md);
          padding: var(--spacing-md);
        }

        .form-item:hover {
          transform: none;
        }

        .form-item-actions {
          width: 100%;
          flex-wrap: wrap;
        }

        .form-item-actions .btn {
          flex: 1;
          min-width: calc(50% - var(--spacing-xs));
        }

        .metrics-grid {
          grid-template-columns: 1fr;
        }

        .metric-card {
          padding: var(--spacing-sm);
        }

        .metric-value {
          font-size: 1.25rem;
        }

        /* Submissions specific styles */
        .submission-card {
          padding: var(--spacing-lg);
          margin-bottom: var(--spacing-lg);
        }

        .submission-header {
          flex-direction: column;
          align-items: flex-start;
          gap: var(--spacing-md);
        }

        .submission-title {
          font-size: 1.25rem;
        }

        .submission-header > div:last-child {
          width: 100%;
          justify-content: flex-start;
        }

        /* Add horizontal scroll to submission data container */
        .submission-data {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          margin: 0 calc(-1 * var(--spacing-lg));
          padding: 0 var(--spacing-lg);
        }

        .data-row {
          flex-direction: row;
          gap: var(--spacing-md);
          padding: var(--spacing-sm);
          min-width: 400px;
        }

        .data-label {
          min-width: 150px;
          font-size: 0.875rem;
          flex-shrink: 0;
        }

        .data-value {
          font-size: 0.875rem;
          flex: 1;
        }

        /* Form-item specific styles (for forms tab) */
        .form-item-info {
          width: 100%;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          padding-right: var(--spacing-sm);
        }

        /* Ensure submission field container scrolls */
        .form-item-info > div[style*="margin-top"] {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          min-width: 400px; /* Force horizontal scroll */
        }

        /* Make submission field rows maintain minimum width */
        .form-item-info > div > div[style*="display: flex"] {
          min-width: 350px;
          flex-shrink: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Navbar -->
    <nav class="top-navbar">
      <div class="navbar-container">
        <button class="hamburger-btn" id="hamburgerBtn">
          <span></span>
          <span></span>
          <span></span>
        </button>

        <a href="/admin/dashboard.html" class="navbar-brand">
          <div>
            <div class="navbar-logo">FitMates</div>
            <p class="navbar-subtitle">Admin Panel</p>
          </div>
        </a>

        <ul class="navbar-menu">
          <li class="navbar-menu-item">
            <a href="/admin/dashboard.html" class="navbar-menu-link">
              <span>üìä</span>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="navbar-menu-item">
            <a href="/admin/clients.html" class="navbar-menu-link active">
              <span>üë•</span>
              <span>Clients</span>
            </a>
          </li>
        </ul>

        <div class="navbar-actions">
          <div class="navbar-user">
            <div class="navbar-avatar" id="navbarAvatar">A</div>
            <div class="navbar-user-info">
              <div class="navbar-user-name" id="navbarUserName">Admin</div>
              <div class="navbar-user-role">Administrator</div>
            </div>
            <!-- Dropdown Menu -->
            <div class="user-dropdown">
              <a href="/admin/profile.html" class="user-dropdown-item">
                <span>üë§</span>
                <span>Visit Profile</span>
              </a>
              <a
                href="#"
                class="user-dropdown-item"
                onclick="event.preventDefault(); auth.logout();"
              >
                <span>üö™</span>
                <span>Logout</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

    <!-- Mobile Sidebar -->
    <aside class="mobile-sidebar" id="mobileSidebar">
      <div class="mobile-sidebar-header">
        <div class="mobile-sidebar-logo">FitMates</div>
        <p class="mobile-sidebar-subtitle">Admin Panel</p>
      </div>

      <nav>
        <ul class="mobile-menu">
          <li class="mobile-menu-item">
            <a href="/admin/dashboard.html" class="mobile-menu-link">
              <span class="mobile-menu-icon">üìä</span>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="mobile-menu-item">
            <a href="/admin/clients.html" class="mobile-menu-link active">
              <span class="mobile-menu-icon">üë•</span>
              <span>Clients</span>
            </a>
          </li>
        </ul>
      </nav>

      <div class="mobile-sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="mobileUserAvatar">A</div>
          <div class="user-details">
            <h4 id="mobileUserName">Admin</h4>
            <p id="mobileUserEmail">admin@fitmates.com</p>
          </div>
        </div>
        <button
          class="btn btn-secondary"
          style="width: 100%"
          onclick="auth.logout()"
        >
          Logout
        </button>
      </div>
    </aside>

    <div class="admin-layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-logo">
          <h2>FitMates</h2>
          <p>Admin Panel</p>
        </div>

        <nav>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item">
              <a href="/admin/dashboard.html" class="sidebar-nav-link">
                <span class="sidebar-nav-icon">üìä</span>
                <span>Dashboard</span>
              </a>
            </li>
            <li class="sidebar-nav-item">
              <a href="/admin/clients.html" class="sidebar-nav-link active">
                <span class="sidebar-nav-icon">üë•</span>
                <span>Clients</span>
              </a>
            </li>
          </ul>
        </nav>

        <div class="sidebar-footer">
          <div class="user-info">
            <div class="user-avatar" id="userAvatar">A</div>
            <div class="user-details">
              <h4 id="userName">Admin</h4>
              <p id="userEmail">admin@fitmates.com</p>
            </div>
          </div>
          <button
            class="btn btn-secondary"
            style="width: 100%"
            onclick="auth.logout()"
          >
            Logout
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <div style="margin-bottom: var(--spacing-lg)">
          <a
            href="/admin/clients.html"
            style="color: var(--color-text-secondary); font-size: 0.875rem"
          >
            ‚Üê Back to Clients
          </a>
        </div>

        <!-- Profile Header -->
        <div class="profile-header" id="profileHeader">
          <div style="text-align: center; width: 100%; padding: 2rem">
            <div class="spinner"></div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab active" onclick="switchTab('forms')">Forms</button>
          <button class="tab" onclick="switchTab('submissions')">
            Submissions
          </button>
          <button class="tab" onclick="switchTab('reports')">Reports</button>
        </div>

        <!-- Forms Tab -->
        <div id="formsTab" class="tab-content active">
          <div class="tab-header">
            <h2>Client Forms</h2>
            <button class="btn btn-primary" onclick="showFormBuilder()">
              <span>‚ûï</span>
              <span>Create New Form</span>
            </button>
          </div>
          <div id="formsList"></div>
        </div>

        <!-- Submissions Tab -->
        <div id="submissionsTab" class="tab-content">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: var(--spacing-xl);
            "
          >
            <h2>Form Submissions</h2>
          </div>
          <div id="submissionsList"></div>
        </div>

        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: var(--spacing-xl);
            "
          >
            <h2>Progress Reports</h2>
          </div>
          <div id="reportsList"></div>
        </div>
      </main>
    </div>

    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/chart.min.js"></script>
    <script src="/admin/assets/form-builder.js"></script>
    <script src="/assets/js/navigation.js"></script>
    <script>
      // Require admin authentication
      auth.requireAdmin();

      // Set user info in all locations
      const user = auth.getCurrentUser();
      if (user) {
        const userName = user.name || "Admin";
        const userEmail = user.email;
        const userInitial = userName[0].toUpperCase();

        // Top navbar
        document.getElementById("navbarUserName").textContent = userName;
        document.getElementById("navbarAvatar").textContent = userInitial;

        // Mobile sidebar
        document.getElementById("mobileUserName").textContent = userName;
        document.getElementById("mobileUserEmail").textContent = userEmail;
        document.getElementById("mobileUserAvatar").textContent = userInitial;
      }

      // Get client ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const clientId = parseInt(urlParams.get("id"));

      if (!clientId) {
        window.location.href = "/admin/clients.html";
      }

      let currentClient = null;

      // Load client data
      async function loadClient() {
        try {
          currentClient = await api.get(`/api/admin/clients/${clientId}`);
          renderClientHeader(currentClient);
          loadForms();
          loadSubmissions();
          loadReports();
        } catch (error) {
          console.error("Error loading client:", error);
          ui.showToast("Failed to load client data", "error");
        }
      }

      // Render client header
      function renderClientHeader(client) {
        document.getElementById("profileHeader").innerHTML = `
        <div class="profile-avatar">${client.name.charAt(0).toUpperCase()}</div>
        <div class="profile-info">
          <h1 class="profile-name">${client.name}</h1>
          <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-md);">${
            client.email
          }</p>
          <div class="profile-meta">
            <div class="profile-meta-item">
              <span>üéÇ</span>
              <span>Age: ${ui.calculateAge(client.dob)}</span>
            </div>
            <div class="profile-meta-item">
              <span>üìè</span>
              <span>Height: ${client.height || "--"} cm</span>
            </div>
            <div class="profile-meta-item">
              <span>‚öñÔ∏è</span>
              <span>Weight: ${client.weight || "--"} kg</span>
            </div>
            <div class="profile-meta-item">
              <span>üì±</span>
              <span>${client.mobile || "No phone"}</span>
            </div>
          </div>
        </div>
        <div>
          <button class="btn btn-secondary" onclick="editClient()">Edit Profile</button>
        </div>
      `;
      }

      // Switch tabs
      function switchTab(tabName) {
        // Update tab buttons
        document
          .querySelectorAll(".tab")
          .forEach((tab) => tab.classList.remove("active"));
        event.target.classList.add("active");

        // Update tab content
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));
        document.getElementById(`${tabName}Tab`).classList.add("active");
      }

      // Load forms
      async function loadForms() {
        try {
          // Fetch both forms and submissions to determine completion status
          const [forms, submissions] = await Promise.all([
            api.get(`/api/forms/client/${clientId}`),
            api.get(`/api/forms/submissions/client/${clientId}`),
          ]);

          // Create a set of submitted form IDs for quick lookup
          const submittedFormIds = new Set(submissions.map((s) => s.form_id));

          renderForms(forms, submittedFormIds);
        } catch (error) {
          console.error("Error loading forms:", error);
          document.getElementById("formsList").innerHTML =
            "<p>Failed to load forms</p>";
        }
      }

      // Render forms
      function renderForms(forms, submittedFormIds) {
        const container = document.getElementById("formsList");

        if (forms.length === 0) {
          container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <h3>No forms yet</h3>
            <p>Create a form to get started</p>
          </div>
        `;
          return;
        }

        container.innerHTML = `
        <div class="forms-list">
          ${forms
            .map((form) => {
              // Determine if form has been submitted by checking submissions
              const isCompleted = submittedFormIds.has(form.id);

              // Determine display status based on form.status and submission existence
              let displayStatus, badgeClass, statusText;
              if (isCompleted) {
                displayStatus = "completed";
                badgeClass = "info";
                statusText = "Completed";
              } else if (form.status === "published") {
                displayStatus = "published";
                badgeClass = "success";
                statusText = "Published";
              } else {
                displayStatus = "draft";
                badgeClass = "warning";
                statusText = "Draft";
              }

              return `
            <div class="form-item">
              <div class="form-item-info">
                <h4>${form.title}</h4>
                <div class="form-item-meta">
                  <span class="badge badge-${badgeClass}">
                    ${statusText}
                  </span>
                  <span style="margin-left: var(--spacing-sm);">
                    Created: ${ui.formatDate(form.created_at)}
                  </span>
                </div>
              </div>
              <div class="form-item-actions">
                <button class="btn btn-sm btn-secondary" onclick='editForm(${JSON.stringify(
                  form
                ).replace(/'/g, "&#39;")})'">
                  Edit
                </button>
                ${
                  form.status === "draft"
                    ? `
                  <button class="btn btn-sm btn-primary" onclick="publishForm('${form.id}')">
                    Publish
                  </button>
                `
                    : `
                  <button class="btn btn-sm btn-warning" onclick="event.preventDefault(); unpublishForm('${form.id}')">
                    Unpublish
                  </button>
                `
                }
                <button class="btn btn-sm btn-outline" onclick="copyForm('${
                  form.id
                }')">
                  Copy
                </button>
                <button class="btn btn-sm btn-secondary" onclick="deleteForm('${
                  form.id
                }')">
                  Delete
                </button>
              </div>
            </div>
          `;
            })
            .join("")}
        </div>
      `;
      }

      // Load submissions
      async function loadSubmissions() {
        try {
          const submissions = await api.get(
            `/api/forms/submissions/client/${clientId}`
          );
          renderSubmissions(submissions);
        } catch (error) {
          console.error("Error loading submissions:", error);
          document.getElementById("submissionsList").innerHTML =
            "<p>Failed to load submissions</p>";
        }
      }

      // Render submissions
      async function renderSubmissions(submissions) {
        const container = document.getElementById("submissionsList");

        if (submissions.length === 0) {
          container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <h3>No submissions yet</h3>
            <p>Submissions will appear here after client fills forms</p>
          </div>
        `;
          return;
        }

        // Get all forms to map form IDs to titles
        const forms = await api.get(`/api/forms/client/${clientId}`);
        const formMap = {};
        forms.forEach((form) => (formMap[form.id] = form));

        container.innerHTML = submissions
          .map((submission) => {
            const form = formMap[submission.form_id];
            const formTitle = form ? form.title : "Unknown Form";
            const submissionData = submission.data;

            return `
          <div class="submission-card">
            <div class="submission-header">
              <div>
                <h3 class="submission-title">${formTitle}</h3>
                <p class="submission-date">Submitted on ${ui.formatDateTime(
                  submission.submitted_at
                )}</p>
              </div>
              <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                <span class="badge badge-success">Completed</span>
              </div>
            </div>
            <div class="submission-data">
              ${renderSubmissionFields(form, submissionData)}
            </div>
          </div>
        `;
          })
          .join("");
      }

      function renderSubmissionFields(form, data) {
        if (!form || !form.data || !form.data.fields)
          return "<p>Form definition not found</p>";

        return form.data.fields
          .map((field) => {
            if (field.type === "dynamic_table") {
              return renderDynamicTableResult(field, data);
            }

            // Normal fields
            const value = data[field.id];
            if (value === undefined) return "";

            let displayValue = value;
            if (field.type === "checkbox") {
              displayValue = value ? "Yes" : "No";
            }

            return `
            <div class="data-row">
                <div class="data-label">${field.label}</div>
                <div class="data-value">${displayValue}</div>
            </div>
            `;
          })
          .join("");
      }

      function renderDynamicTableResult(field, data) {
        const columns = field.columns || [];
        // Determine number of rows from submission data or fallback to initial rows
        const rowCount =
          data[`${field.id}_row_count`] || (field.rows ? field.rows.length : 0);

        // Create array of row indices [0, 1, 2...]
        const rowIndices = Array.from({ length: rowCount }, (_, i) => i);

        return `
        <div style="margin-top: var(--spacing-md); overflow-x: auto;">
            <h5 style="margin-bottom: var(--spacing-sm); color: var(--color-text-primary);">${
              field.label
            }</h5>
            <table class="dynamic-table" style="width: 100%; border-collapse: collapse; min-width: 600px; font-size: 0.9rem;">
                <thead>
                    <tr style="background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1);">
                        ${columns
                          .map(
                            (col) => `
                            <th style="padding: 8px; text-align: left; color: var(--color-text-secondary);">${col.label}</th>
                        `
                          )
                          .join("")}
                    </tr>
                </thead>
                <tbody>
                    ${rowIndices
                      .map(
                        (rowIndex) => `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            ${columns
                              .map((col, colIndex) => {
                                const key = `${field.id}_row_${rowIndex}_col_${colIndex}`;
                                let val = data[key];

                                // Fallback to initial row data if missing (e.g. for admin columns in original rows)
                                if (
                                  val === undefined &&
                                  field.rows &&
                                  field.rows[rowIndex]
                                ) {
                                  val = field.rows[rowIndex][`col_${colIndex}`];
                                }

                                if (val === undefined) val = "-";
                                if (val === true) val = "‚úÖ";
                                if (val === false) val = "‚ùå";

                                return `<td style="padding: 8px;">${val}</td>`;
                              })
                              .join("")}
                        </tr>
                    `
                      )
                      .join("")}
                </tbody>
            </table>
        </div>
        `;
      }

      // Load reports
      async function loadReports() {
        try {
          const reports = await api.get(`/api/reports/client/${clientId}`);
          renderReports(reports);
        } catch (error) {
          console.error("Error loading reports:", error);
          document.getElementById("reportsList").innerHTML =
            "<p>Failed to load reports</p>";
        }
      }

      // Render reports
      function renderReports(reports) {
        const container = document.getElementById("reportsList");

        if (reports.length === 0) {
          container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <h3>No reports yet</h3>
            <p>Reports will appear here after forms are submitted</p>
          </div>
        `;
          return;
        }

        container.innerHTML = `
        <div class="reports-list">
          ${reports.map((report) => renderReportCard(report)).join("")}
        </div>
      `;
      }

      // Render single report card
      function renderReportCard(report) {
        const data = report.generated_report_data;
        const overallScore = data.overall_score || 0;

        return `
        <div class="report-card">
          <div class="report-header">
            <div>
              <h3>${
                data.period.charAt(0).toUpperCase() + data.period.slice(1)
              } Report</h3>
              <p style="color: var(--color-text-secondary); font-size: 0.875rem;">
                Generated: ${ui.formatDateTime(report.created_at)}
              </p>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 2rem; font-weight: 700; color: var(--color-accent-red);">
                ${overallScore.toFixed(1)}%
              </div>
              <div style="font-size: 0.875rem; color: var(--color-text-secondary);">
                Overall Score
              </div>
            </div>
          </div>

          <div class="alert alert-info" style="margin-bottom: var(--spacing-lg);">
            ${data.summary}
          </div>

          <div class="metrics-grid">
            ${data.metrics
              .map(
                (metric) => `
              <div class="metric-card">
                <div class="metric-label">${metric.field}</div>
                <div class="metric-values">
                  <span class="metric-value">${metric.actual}</span>
                  <span class="metric-target">/ ${metric.target} ${
                  metric.unit
                }</span>
                </div>
                <div class="metric-progress">
                  <div class="metric-progress-bar" style="width: ${Math.min(
                    metric.achievement,
                    100
                  )}%"></div>
                </div>
                <div class="metric-status" style="color: var(--color-${
                  metric.status_color
                });">
                  ${metric.achievement.toFixed(1)}% - ${metric.status}
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        </div>
      `;
      }
      // Form actions
      async function publishForm(formId) {
        try {
          await api.post(`/api/forms/${formId}/publish`);
          ui.showToast("Form published successfully!", "success");
          loadForms();
        } catch (error) {
          ui.showToast(error.message || "Failed to publish form", "error");
        }
      }

      async function unpublishForm(formId) {
        // Show confirmation dialog
        const confirmed = confirm(
          "Are you sure you want to unpublish this form? It will no longer be visible to the client."
        );

        // If user clicked Cancel, stop here
        if (!confirmed) {
          console.log("Unpublish cancelled by user");
          return;
        }

        console.log("Unpublishing form:", formId);
        try {
          await api.post(`/api/forms/${formId}/unpublish`);
          ui.showToast("Form unpublished successfully!", "success");
          loadForms();
        } catch (error) {
          ui.showToast(error.message || "Failed to unpublish form", "error");
        }
      }

      async function copyForm(formId) {
        try {
          await api.post(`/api/forms/${formId}/copy?client_id=${clientId}`);
          ui.showToast("Form copied successfully!", "success");
          loadForms();
        } catch (error) {
          ui.showToast(error.message || "Failed to copy form", "error");
        }
      }

      async function deleteForm(formId) {
        ui.confirm("Are you sure you want to delete this form?", async () => {
          try {
            await api.delete(`/api/forms/${formId}`);
            ui.showToast("Form deleted successfully!", "success");
            loadForms();
          } catch (error) {
            ui.showToast(error.message || "Failed to delete form", "error");
          }
        });
      }

      function editClient() {
        // TODO: Implement edit client modal
        ui.showToast("Edit client feature coming soon", "info");
      }

      // Load client data on page load
      loadClient();
    </script>
  </body>
</html>
